<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üîç Profile Verification</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f4f6f8;
      color: #2c3e50;
    }

    .container {
      max-width: 960px;
      margin: 30px auto;
      padding: 30px;
      background-color: #ffffff;
      border-radius: 12px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.07);
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 2rem;
      margin-bottom: 5px;
    }

    .header p {
      font-size: 1rem;
      color: #666;
    }

    .refresh-btn {
      margin-top: 15px;
      padding: 10px 20px;
      background: linear-gradient(to right, #007bff, #0056b3);
      border: none;
      color: white;
      font-weight: 600;
      font-size: 1rem;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .refresh-btn:hover {
      background: linear-gradient(to right, #0056b3, #004080);
    }

    .loading,
    .error,
    .verification-status {
      text-align: center;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
    }

    .loading {
      background: #e0f7fa;
      color: #006064;
    }

    .error {
      background: #fdecea;
      color: #c62828;
      border-left: 5px solid #c62828;
    }

    .verified {
      background: #e6f4ea;
      color: #1b5e20;
      border-left: 5px solid #1b5e20;
    }

    .not-verified {
      background: #fff3e0;
      color: #ef6c00;
      border-left: 5px solid #ef6c00;
    }

    .metadata,
    .profile-section {
      margin: 25px 0;
      padding: 20px;
      background: #f9fafc;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }

    .metadata h4,
    .profile-section h3 {
      margin-top: 0;
      font-size: 1.25rem;
      color: #2c3e50;
      border-bottom: 1px solid #ddd;
      padding-bottom: 8px;
    }

    .metadata p {
      margin: 10px 0;
      font-size: 0.95rem;
    }

    .metadata p strong {
      display: inline-block;
      width: 140px;
      color: #555;
    }

    .field {
      margin: 15px 0;
    }

    .field-label {
      font-weight: 600;
      margin-bottom: 5px;
      color: #555;
    }

    .field-value {
      background-color: #ffffff;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #e0e0e0;
      word-break: break-word;
      font-size: 0.95rem;
    }

    .array-item {
      display: inline-block;
      background-color: #e3f2fd;
      color: #01579b;
      padding: 5px 10px;
      margin: 4px 6px 4px 0;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 500;
    }

    @media (max-width: 768px) {
      .container {
        padding: 20px;
      }

      .header h1 {
        font-size: 1.5rem;
      }

      .field-label {
        font-size: 0.95rem;
      }

      .field-value {
        font-size: 0.9rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üîç Profile Verification</h1>
      <p>Verifying company profile stored on the blockchain</p>
      <button id="refresh-btn" class="refresh-btn">üîÑ Refresh</button>
    </div>

    <div id="status" class="loading">
      <h3>Loading Profile...</h3>
      <p>Fetching the latest available profile from blockchain...</p>
    </div>

    <div id="error" class="error" style="display: none;">
      <h3>‚ùå Error Loading Profile</h3>
      <p id="error-message"></p>
    </div>

    <div id="profile-content" style="display: none;">
      <div id="verification" class="verification-status"></div>

      <section class="metadata">
        <h4>üìã Profile Metadata</h4>
        <p><strong>File ID:</strong> <span id="file-id"></span></p>
        <p><strong>Version:</strong> <span id="version"></span></p>
        <p><strong>Public Key:</strong> <span id="public-key"></span></p>
        <p><strong>Profile Hash:</strong> <span id="profile-hash"></span></p>
        <p><strong>Created:</strong> <span id="created-at"></span></p>
        <p><strong>Updated:</strong> <span id="updated-at"></span></p>
      </section>

      <section class="profile-section">
        <h3>üè¢ Company Profile</h3>
        <div id="profile-fields"></div>
      </section>
    </div>
  </div>

  <script>
    const API = 'http://localhost:3000/blockchain/latest-available';

    const refreshBtn = document.getElementById("refresh-btn");
    const statusDiv = document.getElementById("status");
    const errorDiv = document.getElementById("error");
    const errorMessage = document.getElementById("error-message");
    const profileContent = document.getElementById("profile-content");
    const verificationDiv = document.getElementById("verification");

    refreshBtn.addEventListener("click", loadProfile);

    async function loadProfile() {
      showLoading();
      try {
        const response = await fetch(API);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const { metadata, profile_data, signature_verified } = await response.json();
        if (!profile_data || !metadata) throw new Error("Incomplete profile data");

        renderMetadata(metadata);
        renderProfile(profile_data);
        showVerificationStatus(signature_verified);
        showContent();
      } catch (err) {
        showError("Error fetching profile: " + err.message);
      }
    }

    function showLoading() {
      profileContent.style.display = "none";
      errorDiv.style.display = "none";
      statusDiv.style.display = "block";
    }

    function showError(msg) {
      statusDiv.style.display = "none";
      profileContent.style.display = "none";
      errorDiv.style.display = "block";
      errorMessage.textContent = msg;
    }

    function showContent() {
      statusDiv.style.display = "none";
      errorDiv.style.display = "none";
      profileContent.style.display = "block";
    }

    function showVerificationStatus(valid) {
      verificationDiv.className = "verification-status " + (valid ? "verified" : "not-verified");
      verificationDiv.innerHTML = valid
        ? `<h3>‚úÖ Verified</h3><p>This profile is cryptographically signed and verified.</p>`
        : `<h3>‚ö†Ô∏è Not Verified</h3><p>Signature mismatch. Please contact the issuer or scan a newer QR code.</p>`;
    }

    function renderMetadata(meta) {
      document.getElementById("file-id").textContent = meta.file_id;
      document.getElementById("version").textContent = meta.version;
      document.getElementById("public-key").textContent = meta.public_key;
      document.getElementById("profile-hash").textContent = meta.profile_hash;
      document.getElementById("created-at").textContent = new Date(meta.created_at).toLocaleString();
      document.getElementById("updated-at").textContent = new Date(meta.updated_at).toLocaleString();
    }

    function renderProfile(data) {
      const fields = [
        { key: "company_name", label: "Company Name" },
        { key: "location", label: "Location" },
        { key: "contact", label: "Contact" },
        { key: "size", label: "Size" },
        { key: "established", label: "Established" },
        { key: "revenue", label: "Revenue" },
        { key: "competitive_position", label: "Competitive Position" },
      ];

      const arrays = [
        { key: "market_segments", label: "Market Segments" },
        { key: "technology_focus", label: "Technology Focus" },
        { key: "key_markets", label: "Key Markets" },
        { key: "customer_segments", label: "Customer Segments" },
        { key: "partnerships", label: "Partnerships" },
        { key: "certifications", label: "Certifications" },
        { key: "sales_channels", label: "Sales Channels" },
      ];

      const container = document.getElementById("profile-fields");
      container.innerHTML = "";

      fields.forEach(f => {
        if (data[f.key]) {
          container.innerHTML += `
            <div class="field">
              <div class="field-label">${f.label}</div>
              <div class="field-value">${data[f.key]}</div>
            </div>`;
        }
      });

      arrays.forEach(f => {
        if (Array.isArray(data[f.key])) {
          container.innerHTML += `
            <div class="field">
              <div class="field-label">${f.label}</div>
              <div class="field-value">
                ${data[f.key].map(item => `<span class="array-item">${item}</span>`).join('')}
              </div>
            </div>`;
        }
      });
    }

    loadProfile();
  </script>
</body>
</html>
