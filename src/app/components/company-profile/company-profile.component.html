<!-- Header Section -->
<header class="app-header">
  <div class="header-content">
    <div class="logo-section">
      <div class="logo">üîó</div>
      <div class="title">
        <h1>Profile Data System</h1>
        <p>Blockchain-powered profile management with Hedera integration</p>
      </div>
    </div>
    <div class="header-info">
      <div class="status-indicator">
        <span class="status-dot"></span>
        <span class="status-text">API Disconnected</span>
      </div>
      <div class="status-indicator">
        <span class="status-dot connected"></span>
        <span class="status-text">Blockchain Connected</span>
      </div>
    </div>
  </div>
</header>

<!-- Navigation Tabs -->
<nav class="tab-navigation">
  <div class="tab-container">
    <div class="tabs">
      <button class="tab" [class.active]="activeTab === 'create'" (click)="onTabClick('create')">
        <span class="tab-icon">‚ûï</span>
        <span class="tab-label">Create Profile</span>
      </button>
      <button class="tab" [class.active]="activeTab === 'read'" (click)="onTabClick('read')">
        <span class="tab-icon">üìñ</span>
        <span class="tab-label">Read Profile</span>
      </button>
      <button class="tab" [class.active]="activeTab === 'update'" (click)="onTabClick('update')">
        <span class="tab-icon">‚úèÔ∏è</span>
        <span class="tab-label">Update Profile</span>
      </button>
      <button class="tab" [class.active]="activeTab === 'regulator'" (click)="onTabClick('regulator')">
        <span class="tab-icon">üîç</span>
        <span class="tab-label">Regulatory Profile</span>
      </button>
    </div>
  </div>
</nav>

<!-- Messages Section -->
<div class="messages-container" *ngIf="errorMessage || successMessage || readableError">
  <div class="message error" *ngIf="errorMessage">
    <span class="message-icon">‚ö†Ô∏è</span>
    <span class="message-text">{{ errorMessage }}</span>
  </div>
  <div class="message error" *ngIf="readableError && !errorMessage">
    <span class="message-icon">‚ö†Ô∏è</span>
    <span class="message-text">{{ readableError }}</span>
  </div>
  <div class="message success" *ngIf="successMessage">
    <span class="message-icon">‚úÖ</span>
    <span class="message-text">{{ successMessage }}</span>
  </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" *ngIf="isLoading">
  <div class="loading-spinner">
    <div class="spinner"></div>
  </div>
</div>

<!-- Tab Content -->
<main class="tab-content">
  <div class="content-wrapper">

    <!-- CREATE PROFILE TAB -->
    <div *ngIf="activeTab === 'create'" class="tab-panel">
      <div class="create-profile-container">
        <!-- Header -->
        <div class="header-section">
          <h1>‚ûï Create Company Profile</h1>
          <p>Create a new company profile and receive a private key for secure editing</p>
        </div>

        <!-- Create Profile Form -->
        <form [formGroup]="createForm" (ngSubmit)="createProfile()" class="form-section">
          <div class="form-card">
            <h2>üìã Company Profile Form</h2>

            <!-- Company Information -->
            <div class="form-group">
              <label for="company_name">Company Name *</label>
              <input type="text" id="company_name" formControlName="company_name" class="form-input"
                placeholder="Enter company name">
              <div class="error-message"
                *ngIf="createForm.get('company_name')?.invalid && createForm.get('company_name')?.touched">
                Company name is required
              </div>
            </div>

            <div class="form-group">
              <label for="location">Location *</label>
              <input type="text" id="location" formControlName="location" class="form-input"
                placeholder="Enter company location">
              <div class="error-message"
                *ngIf="createForm.get('location')?.invalid && createForm.get('location')?.touched">
                Location is required
              </div>
            </div>

            <div class="form-group">
              <label for="contact">Contact Information *</label>
              <input type="text" id="contact" formControlName="contact" class="form-input" placeholder="Email | Phone">
              <div class="error-message"
                *ngIf="createForm.get('contact')?.invalid && createForm.get('contact')?.touched">
                Contact information is required
              </div>
            </div>

            <div class="form-group">
              <label for="size">Company Size *</label>
              <input type="text" id="size" formControlName="size" class="form-input" placeholder="e.g., 500+ employees">
              <div class="error-message" *ngIf="createForm.get('size')?.invalid && createForm.get('size')?.touched">
                Company size is required
              </div>
            </div>

            <div class="form-group">
              <label for="established">Year Established *</label>
              <input type="text" id="established" formControlName="established" class="form-input"
                placeholder="e.g., 2015">
              <div class="error-message"
                *ngIf="createForm.get('established')?.invalid && createForm.get('established')?.touched">
                Year established is required
              </div>
            </div>

            <div class="form-group">
              <label for="revenue">Revenue Range *</label>
              <input type="text" id="revenue" formControlName="revenue" class="form-input"
                placeholder="e.g., $50M - $100M">
              <div class="error-message"
                *ngIf="createForm.get('revenue')?.invalid && createForm.get('revenue')?.touched">
                Revenue range is required
              </div>
            </div>

            <!-- Market Segments -->
            <div class="form-group">
              <label>Market Segments</label>
              <div formArrayName="market_segments" class="array-inputs">
                <div *ngFor="let segment of marketSegmentsArray.controls; let i = index" class="array-item">
                  <input type="text" [formControlName]="i" class="form-input" placeholder="Enter market segment">
                  <button type="button" class="remove-btn" (click)="removeArrayItem(marketSegmentsArray, i)">‚ùå</button>
                </div>
                <button type="button" class="add-btn" (click)="addArrayItem(marketSegmentsArray)">‚ûï Add Market
                  Segment</button>
              </div>
            </div>

            <!-- Technology Focus -->
            <div class="form-group">
              <label>Technology Focus</label>
              <div formArrayName="technology_focus" class="array-inputs">
                <div *ngFor="let tech of technologyFocusArray.controls; let i = index" class="array-item">
                  <input type="text" [formControlName]="i" class="form-input" placeholder="Enter technology focus">
                  <button type="button" class="remove-btn" (click)="removeArrayItem(technologyFocusArray, i)">‚ùå</button>
                </div>
                <button type="button" class="add-btn" (click)="addArrayItem(technologyFocusArray)">‚ûï Add Technology
                  Focus</button>
              </div>
            </div>

            <!-- Key Markets -->
            <div class="form-group">
              <label>Key Markets</label>
              <div formArrayName="key_markets" class="array-inputs">
                <div *ngFor="let market of keyMarketsArray.controls; let i = index" class="array-item">
                  <input type="text" [formControlName]="i" class="form-input" placeholder="Enter key market">
                  <button type="button" class="remove-btn" (click)="removeArrayItem(keyMarketsArray, i)">‚ùå</button>
                </div>
                <button type="button" class="add-btn" (click)="addArrayItem(keyMarketsArray)">‚ûï Add Key Market</button>
              </div>
            </div>

            <!-- Customer Segments -->
            <div class="form-group">
              <label>Customer Segments</label>
              <div formArrayName="customer_segments" class="array-inputs">
                <div *ngFor="let segment of customerSegmentsArray.controls; let i = index" class="array-item">
                  <input type="text" [formControlName]="i" class="form-input" placeholder="Enter customer segment">
                  <button type="button" class="remove-btn"
                    (click)="removeArrayItem(customerSegmentsArray, i)">‚ùå</button>
                </div>
                <button type="button" class="add-btn" (click)="addArrayItem(customerSegmentsArray)">‚ûï Add Customer
                  Segment</button>
              </div>
            </div>

            <div class="form-group">
              <label for="competitive_position">Competitive Position *</label>
              <textarea id="competitive_position" formControlName="competitive_position" class="form-textarea"
                placeholder="Describe your competitive position in the market"></textarea>
              <div class="error-message"
                *ngIf="createForm.get('competitive_position')?.invalid && createForm.get('competitive_position')?.touched">
                Competitive position is required
              </div>
            </div>

            <!-- Partnerships -->
            <div class="form-group">
              <label>Partnerships</label>
              <div formArrayName="partnerships" class="array-inputs">
                <div *ngFor="let partner of partnershipsArray.controls; let i = index" class="array-item">
                  <input type="text" [formControlName]="i" class="form-input" placeholder="Enter partnership">
                  <button type="button" class="remove-btn" (click)="removeArrayItem(partnershipsArray, i)">‚ùå</button>
                </div>
                <button type="button" class="add-btn" (click)="addArrayItem(partnershipsArray)">‚ûï Add
                  Partnership</button>
              </div>
            </div>

            <!-- Certifications -->
            <div class="form-group">
              <label>Certifications</label>
              <div formArrayName="certifications" class="array-inputs">
                <div *ngFor="let cert of certificationsArray.controls; let i = index" class="array-item">
                  <!-- File Upload Section -->
                  <div class="file-upload-container">
                    <input type="file" (change)="onFileSelect($event, i)" class="form-input file-input" accept=".pdf,.csv,.png,.jpg,.jpeg,.docx">
                    <div class="file-info" *ngIf="certificationFiles[i]">
                      <span class="file-name">{{ certificationFiles[i].name }}</span>
                      <span class="file-size">({{ (certificationFiles[i].size / 1024 / 1024).toFixed(2) }} MB)</span>
                    </div>
                  </div>
                  
                  <!-- Simplified Certification Details Section -->
                  <div class="certification-details" [formGroup]="$any(cert)">
                    <div class="details-grid">
                      <div class="form-group">
                        <label>Certificate Name *</label>
                        <input type="text" formControlName="certificationName" class="form-input" placeholder="Enter certificate name">
                      </div>
                    </div>
                  </div>
                  
                  <button type="button" class="remove-btn" (click)="removeCertificationItem(i)">‚ùå</button>
                </div>
                <button type="button" class="add-btn" (click)="addCertificationItem()">‚ûï Add Certification</button>
              </div>
              <div class="upload-info">
                <small>Supported formats: PDF, CSV, PNG, JPG, JPEG, DOCX (Max 25MB per file)</small>
              </div>
            </div>
            

            <!-- Sales Channels -->
            <div class="form-group">
              <label>Sales Channels</label>
              <div formArrayName="sales_channels" class="array-inputs">
                <div *ngFor="let channel of salesChannelsArray.controls; let i = index" class="array-item">
                  <input type="text" [formControlName]="i" class="form-input" placeholder="Enter sales channel">
                  <button type="button" class="remove-btn" (click)="removeArrayItem(salesChannelsArray, i)">‚ùå</button>
                </div>
                <button type="button" class="add-btn" (click)="addArrayItem(salesChannelsArray)">‚ûï Add Sales
                  Channel</button>
              </div>
            </div>

            <!-- Private Key -->
            <div class="form-group">
              <label for="private_key">Private Key *</label>
              <div class="private-key-section">
                <input type="password" id="private_key" formControlName="private_key" class="form-input"
                  placeholder="Enter your private key">
                <button type="button" class="btn btn-secondary" (click)="generatePrivateKey()"
                  style="margin-left: 10px;">
                  üîë Generate Private Key
                </button>
              </div>
              <div class="error-message"
                *ngIf="createForm.get('private_key')?.invalid && createForm.get('private_key')?.touched">
                Private key is required
              </div>
              <div class="security-note">
                <p><strong>Security Note:</strong> This private key will be used to authorize future profile updates.
                  Store it securely!</p>
              </div>
            </div>

            <!-- Submit Button -->
            <div class="form-actions">
              <button type="submit" class="btn btn-primary" [disabled]="createForm.invalid || isLoading">
                <span *ngIf="!isLoading"> Create Profile</span>
                <span *ngIf="isLoading"></span>
              </button>
            </div>
          </div>
        </form>

        <!-- Create Profile Success Display -->
        <div class="create-success-section" *ngIf="showCreateSuccess && createdProfileData">
          <div class="success-card">
            <div class="success-header">
              <div class="success-icon">‚úÖ</div>
              <h2>Profile Created Successfully!</h2>
              <p>Your company profile has been stored on the blockchain. Please securely save your private key.</p>
            </div>

            <!-- Security Warning -->
            <div class="security-warning">
              <div class="warning-icon">‚ö†Ô∏è</div>
              <div class="warning-content">
                <h3>Security Warning</h3>
                <p><strong>IMPORTANT:</strong> Your private key is required for all future profile updates and cannot be
                  recovered by the backend. Please save it securely!</p>
                <ul>
                  <li>Store your private key in a secure location</li>
                  <li>Never share your private key with anyone</li>
                  <li>Consider using a password manager or hardware wallet</li>
                  <li>Make multiple backups in different secure locations</li>
                </ul>
              </div>
            </div>

            <!-- Profile Information -->
            <div class="profile-info-grid">
              <div class="info-item">
                <label>File ID</label>
                <div class="info-value">
                  <span class="value-text">{{ createdProfileData.file_id }}</span>
                  <button class="copy-btn" (click)="copyToClipboard(createdProfileData.file_id, 'File ID')">
                    üìã Copy
                  </button>
                </div>
              </div>

              <div class="info-item">
                <label>Public Key</label>
                <div class="info-value">
                  <span class="value-text">{{ createdProfileData.public_key }}</span>
                  <button class="copy-btn" (click)="copyToClipboard(createdProfileData.public_key, 'Public Key')">
                    üìã Copy
                  </button>
                </div>
              </div>

              <div class="info-item private-key-item">
                <label>Private Key</label>
                <div class="info-value">
                  <span class="value-text private-key">{{ createdProfileData.private_key }}</span>
                  <div class="private-key-actions">
                    <button class="copy-btn" (click)="copyToClipboard(createdProfileData.private_key, 'Private Key')">
                      üìã Copy
                    </button>
                    <button class="download-btn" (click)="downloadPrivateKey()">
                      üíæ Download
                    </button>
                  </div>
                </div>
              </div>

              <div class="info-item" *ngIf="createdProfileData.verification_url">
                <label>Verification URL</label>
                <div class="info-value">
                  <a [href]="createdProfileData.verification_url" target="_blank" class="verification-link">
                    üîó View Profile
                  </a>
                </div>
              </div>
            </div>

            <!-- QR Code Section -->
            <div class="qr-section" *ngIf="createdProfileData.qr_code_data">
              <h3>QR Code</h3>
              <div class="qr-container">
                <div class="qr-code-text">{{ createdProfileData.qr_code_data }}</div>
                <p>Scan this QR code to view your profile</p>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="success-actions">
              <button class="btn btn-secondary" (click)="closeCreateSuccess()">
                ‚ú® Create Another Profile
              </button>
              <button class="btn btn-primary" (click)="setActiveTab('update')">
                ‚úèÔ∏è Update Profile
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- READ PROFILE TAB -->
    <div *ngIf="activeTab === 'read'" class="tab-panel">
      <div class="read-profile-container">
        <!-- Header -->
        <div class="header-section">
          <h1>üìñ Read Single Latest Profile</h1>
          <p>View the single most recently created or updated company profile from the blockchain</p>
        </div>

        <!-- Debug Info -->


        <!-- Loading State -->
        <div class="loading-state" *ngIf="readProfileLoading">
          <div class="loading-spinner">
            <div class="spinner"></div>
          </div>
        </div>

        <!-- Error State -->
        <div class="error-state" *ngIf="readProfileError && !readProfileLoading">
          <div class="error-card">
            <div class="error-icon">‚ùå</div>
            <h3>Error Loading Latest Profile</h3>
            <p>{{ readProfileError }}</p>
            <button class="btn btn-primary" (click)="loadSingleLatestProfile()">üîÑ Retry</button>
          </div>
        </div>

        <!-- Profile Display -->
        <div class="profile-display" *ngIf="currentProfile && !readProfileLoading">
          <div class="profile-card">
            <!-- Profile Metadata -->
            <div class="profile-metadata" *ngIf="latestProfileData">
              <div class="metadata-grid">
                <div class="metadata-item">
                  <label>Version</label>
                  <span>{{ latestProfileData.metadata.version }}</span>
                </div>
                <div class="metadata-item">
                  <label>Last Updated</label>
                  <span>{{ latestProfileData.metadata.updated_at | date:'medium' }}</span>
                </div>
                <div class="metadata-item">
                  <label>Signature Verified</label>
                  <span [class.verified]="latestProfileData.signature_verified">
                    {{ latestProfileData.signature_verified ? '‚úÖ Verified' : '‚ùå Not Verified' }}
                  </span>
                </div>
              </div>
            </div>

            <div class="profile-header">
              <h2>{{ currentProfile.company_name }}</h2>
              <div class="profile-meta">
                <span class="meta-item">üìç {{ currentProfile.location }}</span>
                <span class="meta-item">üë• {{ currentProfile.size }}</span>
                <span class="meta-item">üìÖ Established: {{ currentProfile.established }}</span>
              </div>
            </div>

            <div class="profile-section">
              <h3>üìû Contact Information</h3>
              <p>{{ currentProfile.contact }}</p>
            </div>

            <div class="profile-section">
              <h3>üí∞ Revenue</h3>
              <p>{{ currentProfile.revenue }}</p>
            </div>

            <div class="profile-section">
              <h3>üéØ Market Segments</h3>
              <div class="tags" *ngIf="currentProfile.market_segments.length > 0">
                <span class="tag" *ngFor="let segment of currentProfile.market_segments">{{ segment }}</span>
              </div>
              <p *ngIf="currentProfile.market_segments.length === 0" class="no-data">No market segments specified</p>
            </div>

            <div class="profile-section">
              <h3>üî¨ Technology Focus</h3>
              <div class="tags" *ngIf="currentProfile.technology_focus.length > 0">
                <span class="tag" *ngFor="let tech of currentProfile.technology_focus">{{ tech }}</span>
              </div>
              <p *ngIf="currentProfile.technology_focus.length === 0" class="no-data">No technology focus specified</p>
            </div>

            <div class="profile-section">
              <h3>üåç Key Markets</h3>
              <div class="tags" *ngIf="currentProfile.key_markets.length > 0">
                <span class="tag" *ngFor="let market of currentProfile.key_markets">{{ market }}</span>
              </div>
              <p *ngIf="currentProfile.key_markets.length === 0" class="no-data">No key markets specified</p>
            </div>

            <div class="profile-section">
              <h3>üë• Customer Segments</h3>
              <div class="tags" *ngIf="currentProfile.customer_segments.length > 0">
                <span class="tag" *ngFor="let segment of currentProfile.customer_segments">{{ segment }}</span>
              </div>
              <p *ngIf="currentProfile.customer_segments.length === 0" class="no-data">No customer segments specified
              </p>
            </div>

            <div class="profile-section">
              <h3>üèÜ Competitive Position</h3>
              <p>{{ currentProfile.competitive_position || 'No competitive position specified' }}</p>
            </div>

            <div class="profile-section">
              <h3>ü§ù Partnerships</h3>
              <div class="tags" *ngIf="currentProfile.partnerships.length > 0">
                <span class="tag" *ngFor="let partner of currentProfile.partnerships">{{ partner }}</span>
              </div>
              <p *ngIf="currentProfile.partnerships.length === 0" class="no-data">No partnerships specified</p>
            </div>

            <div class="profile-section">
              <h3>üèÖ Certifications</h3>
              <div class="certifications-container" *ngIf="currentProfile.certifications.length > 0">
                <div class="certification-item" *ngFor="let cert of currentProfile.certifications; let i = index">
                  <div class="certification-info">
                    <span class="certification-name">{{ getCertificationDisplayName(cert) }}</span>
                    <div class="certification-actions">
                      <button class="btn btn-primary btn-sm" (click)="downloadFile(getCertificationUrl(cert), getCertificationDisplayName(cert))">
                        üì• Download
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              <p *ngIf="currentProfile.certifications.length === 0" class="no-data">No certifications specified</p>
            </div>



            <div class="profile-section">
              <h3>ÔøΩÔøΩ Sales Channels</h3>
              <div class="tags" *ngIf="currentProfile.sales_channels.length > 0">
                <span class="tag" *ngFor="let channel of currentProfile.sales_channels">{{ channel }}</span>
              </div>
              <p *ngIf="currentProfile.sales_channels.length === 0" class="no-data">No sales channels specified</p>
            </div>
          </div>
        </div>

        <!-- No Profile Message -->
        <div class="no-profile" *ngIf="!currentProfile && !readProfileLoading && !readProfileError">
          <div class="empty-state">
            <div class="empty-icon">üìñ</div>
            <h3>No Latest Profile Available</h3>
            <p>No company profiles have been created yet. Create a profile first to view it here.</p>
          </div>
        </div>





        <!-- QR Code Display Section -->
        <div class="qr-code-section" *ngIf="activeTab === 'read' && currentProfile && !readProfileLoading && !hideQRCodeSection">
          <div class="qr-code-card">
            <h3>üì± QR Code for Verification</h3>
            
            <div class="qr-code-container">
              <img [src]="qrCodeDataUrl" alt="QR Code" class="qr-code-image">
            </div>
            
            <div class="qr-code-details">
              <div class="detail-item">
                <strong>URL:</strong> 
                <span class="url-text">{{ qrCodeUrl }}</span>
                <button class="copy-btn" (click)="copyToClipboard(qrCodeUrl, 'Verification URL')">üìã Copy</button>
              </div>
            </div>
            
            <div class="qr-code-actions">
              <button class="btn btn-primary" (click)="openVerificationPage()">
                üîó Open Verification Page
              </button>
              <button class="btn btn-secondary" (click)="hideQRCode()">
                ‚ùå Hide QR Code
              </button>
            </div>
            
            <p class="qr-code-note">
              Scan this QR code with any mobile device to verify the company profile
            </p>
          </div>
        </div>

      </div>
    </div>

    <!-- UPDATE PROFILE TAB -->
    <div *ngIf="activeTab === 'update'" class="tab-panel">
      <div class="update-profile-container">
        <!-- Header -->
        <div class="header-section">
          <h1>‚úèÔ∏è Update Company Profile</h1>
          <p>Enter your private key to load and update your company profile</p>
        </div>

        <!-- Update Profile Messages -->
        <div class="messages-container" *ngIf="updateProfileError || updateProfileSuccess">
          <div class="message error" *ngIf="updateProfileError">
            <span class="message-icon">‚ö†Ô∏è</span>
            <span class="message-text">{{ updateProfileError }}</span>
          </div>
          <div class="message success" *ngIf="updateProfileSuccess">
            <span class="message-icon">‚úÖ</span>
            <span class="message-text">{{ updateProfileSuccess }}</span>
          </div>
        </div>

        <!-- Update Profile Loading Overlay -->
        <div class="loading-overlay" *ngIf="updateProfileLoading">
          <div class="loading-spinner">
            <div class="spinner"></div>
          </div>
        </div>

        <!-- Private Key Form -->
        <div class="private-key-section" *ngIf="!privateKeyValidated && !updateProfileLoading">
          <div class="form-card">
            <h2>üîê Private Key Authentication</h2>
            <p>Enter your private key to access and edit your profile</p>

            <!-- Security Warning -->
            <div class="security-warning">
              <div class="warning-icon">‚ö†Ô∏è</div>
              <div class="warning-content">
                <h3>Security Notice</h3>
                <p><strong>IMPORTANT:</strong> Only the original private key used during profile creation can authorize
                  updates.</p>
                <ul>
                  <li>Enter the exact private key from your profile creation</li>
                  <li>This key is required to validate your ownership</li>
                  <li>If you've lost your private key, you cannot update this profile</li>
                  <li>Consider creating a new profile if you cannot locate your private key</li>
                </ul>
              </div>
            </div>

            <form [formGroup]="privateKeyForm" (ngSubmit)="validatePrivateKey()" class="private-key-form">
              <div class="form-group">
                <label for="private_key">Private Key *</label>
                <input type="password" id="private_key" formControlName="private_key" class="form-input"
                  placeholder="Enter your private key">
                <div class="error-message"
                  *ngIf="privateKeyForm.get('private_key')?.invalid && privateKeyForm.get('private_key')?.touched">
                  Private key is required
                </div>
              </div>

              <div class="form-actions">
                <button type="submit" class="btn btn-primary"
                  [disabled]="privateKeyForm.invalid || updateProfileLoading">
                  <span *ngIf="!updateProfileLoading">üîì Validate & Load Profile</span>
                  <span *ngIf="updateProfileLoading"></span>
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Update Profile Form -->
        <div class="update-form-section" *ngIf="privateKeyValidated && currentProfile && !updateProfileLoading">
          <div class="form-card">
            <div class="profile-info">
              <h2>üìù Edit Profile: {{ currentProfile.company_name }}</h2>
              <p><strong>File ID:</strong> {{ fileId }}</p>
              <p><strong>Public Key:</strong> {{ publicKey }}</p>
              <p><strong>Authorization:</strong> ‚úÖ Private key validated</p>
            </div>

            <!-- Authorization Success Message -->
            <div class="authorization-success">
              <div class="success-icon">üîê</div>
              <div class="success-content">
                <h3>Profile Loaded Successfully</h3>
                <p>Your private key has been validated. You can now edit the profile data below.</p>
                <p><strong>Note:</strong> You must enter your private key again in the form below to authorize the
                  update.</p>
              </div>
            </div>

            <form [formGroup]="updateForm" (ngSubmit)="updateProfile()" class="update-form">
              <!-- Company Information -->
              <div class="form-group">
                <label for="update_company_name">Company Name *</label>
                <input type="text" id="update_company_name" formControlName="company_name" class="form-input">
                <div class="error-message"
                  *ngIf="updateForm.get('company_name')?.invalid && updateForm.get('company_name')?.touched">
                  Company name is required
                </div>
              </div>

              <div class="form-group">
                <label for="update_location">Location *</label>
                <input type="text" id="update_location" formControlName="location" class="form-input">
                <div class="error-message"
                  *ngIf="updateForm.get('location')?.invalid && updateForm.get('location')?.touched">
                  Location is required
                </div>
              </div>

              <div class="form-group">
                <label for="update_contact">Contact Information *</label>
                <input type="text" id="update_contact" formControlName="contact" class="form-input">
                <div class="error-message"
                  *ngIf="updateForm.get('contact')?.invalid && updateForm.get('contact')?.touched">
                  Contact information is required
                </div>
              </div>

              <div class="form-group">
                <label for="update_size">Company Size *</label>
                <input type="text" id="update_size" formControlName="size" class="form-input">
                <div class="error-message" *ngIf="updateForm.get('size')?.invalid && updateForm.get('size')?.touched">
                  Company size is required
                </div>
              </div>

              <div class="form-group">
                <label for="update_established">Year Established *</label>
                <input type="text" id="update_established" formControlName="established" class="form-input">
                <div class="error-message"
                  *ngIf="updateForm.get('established')?.invalid && updateForm.get('established')?.touched">
                  Year established is required
                </div>
              </div>

              <div class="form-group">
                <label for="update_revenue">Revenue Range *</label>
                <input type="text" id="update_revenue" formControlName="revenue" class="form-input">
                <div class="error-message"
                  *ngIf="updateForm.get('revenue')?.invalid && updateForm.get('revenue')?.touched">
                  Revenue range is required
                </div>
              </div>

              <!-- Market Segments -->
              <div class="form-group">
                <label>Market Segments</label>
                <div formArrayName="market_segments" class="array-inputs">
                  <div *ngFor="let segment of updateMarketSegmentsArray.controls; let i = index" class="array-item">
                    <input type="text" [formControlName]="i" class="form-input" placeholder="Enter market segment">
                    <button type="button" class="remove-btn"
                      (click)="removeArrayItem(updateMarketSegmentsArray, i)">‚ùå</button>
                  </div>
                  <button type="button" class="add-btn" (click)="addArrayItem(updateMarketSegmentsArray)">‚ûï Add Market
                    Segment</button>
                </div>
              </div>

              <!-- Technology Focus -->
              <div class="form-group">
                <label>Technology Focus</label>
                <div formArrayName="technology_focus" class="array-inputs">
                  <div *ngFor="let tech of updateTechnologyFocusArray.controls; let i = index" class="array-item">
                    <input type="text" [formControlName]="i" class="form-input" placeholder="Enter technology focus">
                    <button type="button" class="remove-btn"
                      (click)="removeArrayItem(updateTechnologyFocusArray, i)">‚ùå</button>
                  </div>
                  <button type="button" class="add-btn" (click)="addArrayItem(updateTechnologyFocusArray)">‚ûï Add
                    Technology Focus</button>
                </div>
              </div>

              <!-- Key Markets -->
              <div class="form-group">
                <label>Key Markets</label>
                <div formArrayName="key_markets" class="array-inputs">
                  <div *ngFor="let market of updateKeyMarketsArray.controls; let i = index" class="array-item">
                    <input type="text" [formControlName]="i" class="form-input" placeholder="Enter key market">
                    <button type="button" class="remove-btn"
                      (click)="removeArrayItem(updateKeyMarketsArray, i)">‚ùå</button>
                  </div>
                  <button type="button" class="add-btn" (click)="addArrayItem(updateKeyMarketsArray)">‚ûï Add Key
                    Market</button>
                </div>
              </div>

              <!-- Customer Segments -->
              <div class="form-group">
                <label>Customer Segments</label>
                <div formArrayName="customer_segments" class="array-inputs">
                  <div *ngFor="let segment of updateCustomerSegmentsArray.controls; let i = index" class="array-item">
                    <input type="text" [formControlName]="i" class="form-input" placeholder="Enter customer segment">
                    <button type="button" class="remove-btn"
                      (click)="removeArrayItem(updateCustomerSegmentsArray, i)">‚ùå</button>
                  </div>
                  <button type="button" class="add-btn" (click)="addArrayItem(updateCustomerSegmentsArray)">‚ûï Add
                    Customer Segment</button>
                </div>
              </div>

              <div class="form-group">
                <label for="update_competitive_position">Competitive Position *</label>
                <textarea id="update_competitive_position" formControlName="competitive_position"
                  class="form-textarea"></textarea>
                <div class="error-message"
                  *ngIf="updateForm.get('competitive_position')?.invalid && updateForm.get('competitive_position')?.touched">
                  Competitive position is required
                </div>
              </div>

              <!-- Partnerships -->
              <div class="form-group">
                <label>Partnerships</label>
                <div formArrayName="partnerships" class="array-inputs">
                  <div *ngFor="let partner of updatePartnershipsArray.controls; let i = index" class="array-item">
                    <input type="text" [formControlName]="i" class="form-input" placeholder="Enter partnership">
                    <button type="button" class="remove-btn"
                      (click)="removeArrayItem(updatePartnershipsArray, i)">‚ùå</button>
                  </div>
                  <button type="button" class="add-btn" (click)="addArrayItem(updatePartnershipsArray)">‚ûï Add
                    Partnership</button>
                </div>
              </div>

              <!-- Certifications -->
              <div class="form-group">
                <label>Certifications</label>
                <div class="certification-summary" *ngIf="updateCertificationItems.length > 0">
                  <small class="summary-text">
                    üìä {{ getCertificationFilesSummary() }}
                  </small>
                </div>
                <div formArrayName="certifications" class="array-inputs">
                  <div *ngFor="let cert of updateCertificationsArray.controls; let i = index" class="array-item">
                    <!-- File Upload Section -->
                    <div class="file-upload-container">
                      <div class="file-status-indicator">
                        <span class="status-badge existing" *ngIf="isPreservingCertification(i)">EXISTING</span>
                        <span class="status-badge replacing" *ngIf="isReplacingCertification(i)">REPLACING</span>
                        <span class="status-badge new" *ngIf="isAppendingCertification(i)">NEW</span>
                        <span class="status-badge removed" *ngIf="updateCertificationItems[i]?.operation === 'remove'">REMOVED</span>
                        <span class="status-badge empty" *ngIf="isEmptyCertificationSlot(i)">EMPTY</span>
                      </div>
                      <input type="file" (change)="onUpdateFileSelect($event, i)" class="form-input file-input" accept=".pdf,.csv,.png,.jpg,.jpeg,.docx">
                      <div class="file-info" *ngIf="hasCertificationFile(i)">
                        <span class="file-name">{{ getCertificationFileName(i) }}</span>
                        <span class="file-size" *ngIf="isAppendingCertification(i) && updateCertificationItems[i]?.file">({{ getFileSizeInMB(i) }} MB)</span>
                        <span class="file-status" *ngIf="isPreservingCertification(i)">(existing file)</span>
                        <span class="file-status replacing" *ngIf="isReplacingCertification(i)">(replacing existing file)</span>
                        <span class="file-status new" *ngIf="isAppendingCertification(i)">(new file)</span>
                        <span class="file-status removed" *ngIf="updateCertificationItems[i]?.operation === 'remove'">(marked for removal)</span>
                        <span class="file-status empty" *ngIf="isEmptyCertificationSlot(i)">(empty slot - upload to add)</span>
                      </div>
                    </div>
                    
                                      <!-- Simplified Certification Details Section -->
                  <div class="certification-details" [formGroup]="$any(cert)">
                    <div class="details-grid">
                      <div class="form-group">
                        <label>Certificate Name *</label>
                        <input type="text" formControlName="certificationName" class="form-input" placeholder="Enter certificate name">
                      </div>
                    </div>
                  </div>
                    
                    <div class="file-actions">
                      <button type="button" class="restore-btn" *ngIf="updateCertificationItems[i]?.operation === 'remove'" 
                              (click)="restoreUpdateCertificationItem(i)" title="Restore file">
                        üîÑ
                      </button>
                      <button type="button" class="remove-btn" (click)="removeUpdateCertificationItem(i)" 
                              [title]="updateCertificationItems[i] && updateCertificationItems[i].operation === 'remove' ? 'Confirm removal' : 'Remove file'">
                        {{ updateCertificationItems[i] && updateCertificationItems[i].operation === 'remove' ? 'üóëÔ∏è' : '‚ùå' }}
                      </button>
                    </div>
                  </div>
                  <button type="button" class="add-btn" (click)="addUpdateCertificationItem()">‚ûï Add Certification</button>
                </div>
                <div class="file-management-actions" *ngIf="updateCertificationItems.length > 0">
                  <button type="button" class="utility-btn" (click)="cleanupEmptyCertificationSlots()" title="Remove empty file slots">
                    üßπ Clean Empty Slots
                  </button>
                  <button type="button" class="utility-btn" (click)="resetCertificationFiles()" title="Reset to original files">
                    üîÑ Reset Files
                  </button>
                  <button type="button" class="utility-btn" (click)="debugCertificationFiles()" title="Debug file state">
                    üêõ Debug Files
                  </button>
                  <button type="button" class="utility-btn" (click)="debugCertificationItemsState()" title="Debug certification items state">
                    üîç Debug Items State
                  </button>
                  <button type="button" class="utility-btn" (click)="checkBackendFileStorage()" title="Check backend file storage">
                    üîç Check Backend Files
                  </button>
                </div>
                <div class="upload-info">
                  <small>Supported formats: PDF, CSV, PNG, JPG, JPEG, DOCX (Max 25MB per file)</small>
                </div>
              </div>

              <!-- Sales Channels -->
              <div class="form-group">
                <label>Sales Channels</label>
                <div formArrayName="sales_channels" class="array-inputs">
                  <div *ngFor="let channel of updateSalesChannelsArray.controls; let i = index" class="array-item">
                    <input type="text" [formControlName]="i" class="form-input" placeholder="Enter sales channel">
                    <button type="button" class="remove-btn"
                      (click)="removeArrayItem(updateSalesChannelsArray, i)">‚ùå</button>
                  </div>
                  <button type="button" class="add-btn" (click)="addArrayItem(updateSalesChannelsArray)">‚ûï Add Sales
                    Channel</button>
                </div>
              </div>



              <!-- Update Preview -->
              <div class="update-preview" *ngIf="hasCertificationChanges()">
                <div class="preview-header">
                  <h4>üìã Update Preview</h4>
                </div>
                <div class="preview-content">
                  <pre>{{ showUpdatePreview() }}</pre>
                </div>
              </div>

              <!-- Submit Button -->
              <div class="form-actions">
                <button type="submit" class="btn btn-primary" [disabled]="updateForm.invalid || updateProfileLoading">
                  <span *ngIf="!updateProfileLoading">üíæ Update Profile</span>
                  <span *ngIf="updateProfileLoading">‚è≥ Updating...</span>
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- REGULATOR PROFILE TAB -->
    <div *ngIf="activeTab === 'regulator'" class="tab-panel">
      <div class="regulator-profile-container">
        <!-- Header -->
        <div class="header-section">
          <h1>üîç Regulatory Profile</h1>
          <p>Regulatory oversight and audit functionality for blockchain profiles</p>
        </div>

        <!-- Loading State -->
        <div *ngIf="regulatorProfileLoading" class="loading-section">
          <div class="loading-spinner">
            <div class="spinner"></div>
          </div>
        </div>

        <!-- Error State -->
        <div *ngIf="regulatorProfileError" class="error-section">
          <div class="error-message">
            <span class="error-icon">‚ùå</span>
            <span>{{ regulatorProfileError }}</span>
          </div>
        </div>

        <!-- No Profile Available -->
        <div *ngIf="!regulatorProfileLoading && !regulatorProfileError && !regulatorProfileData"
          class="no-profile-section">
          <div class="no-profile-card">
            <div class="no-profile-icon">üìã</div>
            <h2>No Profile Available</h2>
            <p>No company profiles are currently available for regulatory oversight.</p>
            <p>Create a profile in the "Create Profile" tab to view it here.</p>
          </div>
        </div>

        <!-- Regulator Profile Data -->
        <div *ngIf="!regulatorProfileLoading && !regulatorProfileError && regulatorProfileData"
          class="regulator-content">

          <!-- Current Profile Section -->
          <div class="current-profile-section">
            <div class="profile-header-with-actions">
              <h2>üìä Current Profile Data</h2>
            </div>
            <div class="profile-card">
              <div class="profile-header">
                <h3>{{ regulatorProfileData.current_profile.company_name || 'Unnamed Company' }}</h3>
                <span class="profile-status">Current Version</span>
              </div>

              <div class="profile-details">
                <div class="detail-row">
                  <span class="label">Company Name:</span>
                  <span class="value">{{ regulatorProfileData.current_profile.company_name || 'N/A' }}</span>
                </div>
                <div class="detail-row">
                  <span class="label">Location:</span>
                  <span class="value">{{ regulatorProfileData.current_profile.location || 'N/A' }}</span>
                </div>
                <div class="detail-row">
                  <span class="label">Contact:</span>
                  <span class="value">{{ regulatorProfileData.current_profile.contact || 'N/A' }}</span>
                </div>
                <div class="detail-row">
                  <span class="label">Size:</span>
                  <span class="value">{{ regulatorProfileData.current_profile.size || 'N/A' }}</span>
                </div>
                <div class="detail-row">
                  <span class="label">Established:</span>
                  <span class="value">{{ regulatorProfileData.current_profile.established || 'N/A' }}</span>
                </div>
                <div class="detail-row">
                  <span class="label">Revenue:</span>
                  <span class="value">{{ regulatorProfileData.current_profile.revenue || 'N/A' }}</span>
                </div>
                <div class="detail-row">
                  <span class="label">Competitive Position:</span>
                  <span class="value">{{ regulatorProfileData.current_profile.competitive_position || 'N/A' }}</span>
                </div>

                <!-- Arrays -->
                <div class="detail-row" *ngIf="safeHasArrayContent(regulatorProfileData.current_profile, 'market_segments')">
                  <span class="label">Market Segments:</span>
                  <span class="value">{{ safeGetProfileValue(regulatorProfileData.current_profile, 'market_segments')?.join(', ') }}</span>
                </div>
                <div class="detail-row" *ngIf="safeHasArrayContent(regulatorProfileData.current_profile, 'technology_focus')">
                  <span class="label">Technology Focus:</span>
                  <span class="value">{{ safeGetProfileValue(regulatorProfileData.current_profile, 'technology_focus')?.join(', ') }}</span>
                </div>
                <div class="detail-row" *ngIf="safeHasArrayContent(regulatorProfileData.current_profile, 'key_markets')">
                  <span class="label">Key Markets:</span>
                  <span class="value">{{ safeGetProfileValue(regulatorProfileData.current_profile, 'key_markets')?.join(', ') }}</span>
                </div>
                <div class="detail-row" *ngIf="safeHasArrayContent(regulatorProfileData.current_profile, 'customer_segments')">
                  <span class="label">Customer Segments:</span>
                  <span class="value">{{ safeGetProfileValue(regulatorProfileData.current_profile, 'customer_segments')?.join(', ') }}</span>
                </div>
                <div class="detail-row" *ngIf="safeHasArrayContent(regulatorProfileData.current_profile, 'partnerships')">
                  <span class="label">Partnerships:</span>
                  <span class="value">{{ safeGetProfileValue(regulatorProfileData.current_profile, 'partnerships')?.join(', ') }}</span>
                </div>
                <div class="detail-row" *ngIf="safeHasArrayContent(regulatorProfileData.current_profile, 'certifications')">
                  <span class="label">Certifications:</span>
                  <div class="value">
                    <div class="certifications-container">
                      <div class="certification-item" *ngFor="let cert of safeGetProfileValue(regulatorProfileData.current_profile, 'certifications'); let i = index; trackBy: trackByCertification">
                        <div class="certification-info" *ngIf="isValidCertification(cert)">
                          <span class="certification-name">{{ getCertificationDisplayName(cert) }}</span>
                          <div class="certification-actions">
                            <button class="btn btn-primary btn-sm" (click)="safeDownloadCertification(cert)">
                              üì• Download
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="detail-row" *ngIf="safeHasArrayContent(regulatorProfileData.current_profile, 'sales_channels')">
                  <span class="label">Sales Channels:</span>
                  <span class="value">{{ safeGetProfileValue(regulatorProfileData.current_profile, 'sales_channels')?.join(', ') }}</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Profile History Section -->
          <div class="profile-history-section">
            <h2>üìã Complete Profile History</h2>
            <div class="history-info">
              <p>Total versions: {{ regulatorProfileData.history.length }}</p>
              <p>Debug: History data available: {{ regulatorProfileData.history ? 'Yes' : 'No' }}</p>
            </div>

            <!-- Debug Information -->
            <div class="debug-info" style="background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px;">
              <h4>üîç Debug Information</h4>
              <p>History Array Length: {{ regulatorProfileData.history?.length || 0 }}</p>
              <p>First History Item: {{ regulatorProfileData.history?.[0] ? 'Exists' : 'Not Found' }}</p>
              <p>First Item Version: {{ regulatorProfileData.history?.[0]?.version || 'N/A' }}</p>
              <p>First Item Has Change Info: {{ regulatorProfileData.history?.[0]?.change_info ? 'Yes' : 'No' }}</p>
              <p>First Item Changed Fields: {{ regulatorProfileData.history?.[0]?.change_info?.changed_fields?.length || 0 }}</p>
            </div>

            <div class="history-timeline" *ngIf="regulatorProfileData.history && regulatorProfileData.history.length > 0">
              <div class="history-item" *ngFor="let version of regulatorProfileData.history; let i = index">
                <div class="version-header">
                  <h3>
                    <span *ngIf="version.version === 1" class="version-badge latest">Latest Version</span>
                    <span *ngIf="version.version !== 1" class="version-badge">Version {{ version.version }}</span>
                  </h3>
                  <p class="timestamp">{{ version.timestamp | date:'MMM d, y, h:mm:ss a' }}</p>
                </div>

                <div class="version-details">
                  <div class="detail-row">
                    <span class="label">Profile Hash:</span>
                    <span class="value hash-value">{{ version.profile_hash || 'N/A' }}</span>
                  </div>
                  <div class="detail-row">
                    <span class="label">Public Key:</span>
                    <span class="value hash-value">{{ version.public_key || 'N/A' }}</span>
                  </div>
                  <div class="detail-row">
                    <span class="label">Signature:</span>
                    <span class="value hash-value">{{ version.signature || 'N/A' }}</span>
                  </div>
                </div>

                <!-- Profile Data Display -->
                <div class="profile-data-display">
                  <h4>üìä Profile Data (Version {{ version.version }})</h4>
                  <div class="profile-details">
                    <div class="detail-row">
                      <span class="label">Company Name:</span>
                      <span class="value">{{ version.profile_data?.company_name || 'N/A' }}</span>
                    </div>
                    <div class="detail-row">
                      <span class="label">Location:</span>
                      <span class="value">{{ version.profile_data?.location || 'N/A' }}</span>
                    </div>
                    <div class="detail-row">
                      <span class="label">Contact:</span>
                      <span class="value">{{ version.profile_data?.contact || 'N/A' }}</span>
                    </div>
                    <div class="detail-row">
                      <span class="label">Size:</span>
                      <span class="value">{{ version.profile_data?.size || 'N/A' }}</span>
                    </div>
                    <div class="detail-row">
                      <span class="label">Established:</span>
                      <span class="value">{{ version.profile_data?.established || 'N/A' }}</span>
                    </div>
                    <div class="detail-row">
                      <span class="label">Revenue:</span>
                      <span class="value">{{ version.profile_data?.revenue || 'N/A' }}</span>
                    </div>
                    <div class="detail-row">
                      <span class="label">Competitive Position:</span>
                      <span class="value">{{ version.profile_data?.competitive_position || 'N/A' }}</span>
                    </div>
                  </div>
                </div>



                <!-- Field Changes Summary (if available) -->
                <div *ngIf="version.change_info && version.change_info.changed_fields && version.change_info.changed_fields.length > 0"
                  class="change-summary">
                  <h4>üîç Field Changes in This Version</h4>
                  <div class="changed-fields-list">
                    <div *ngFor="let field of version.change_info.changed_fields" class="changed-field">
                      <span class="field-name">{{ field }}</span>
                      <span class="change-type-badge" [class]="'change-type-' + getFieldChangeType(version, field)">
                        {{ getFieldChangeTypeDetailed(version, field) }}
                      </span>
                    </div>
                  </div>
                </div>

                <!-- Debug: Show change_info structure -->
                

                <!-- Simple Comparison (if change_info is available) -->
                <div *ngIf="version.change_info"
                  class="simple-comparison">
                  <h4>üìä Simple Comparison</h4>
                  
                  <!-- Show comparison if we have both old and new values -->
                  <div *ngIf="version.change_info.old_values && version.change_info.new_values" class="comparison-grid">
                    <div class="comparison-column">
                      <div class="column-header">Before</div>
                      <div class="profile-table">
                        <div class="field-row">
                          <span class="field-name">Company Name:</span>
                          <span class="field-value">{{ version.change_info?.old_values?.company_name || 'N/A' }}</span>
                        </div>
                        <div class="field-row">
                          <span class="field-name">Location:</span>
                          <span class="field-value">{{ version.change_info?.old_values?.location || 'N/A' }}</span>
                        </div>
                        <div class="field-row">
                          <span class="field-name">Contact Information:</span>
                          <span class="field-value">{{ version.change_info?.old_values?.contact || 'N/A' }}</span>
                        </div>
                        <div class="field-row">
                          <span class="field-name">Company Size:</span>
                          <span class="field-value">{{ version.change_info?.old_values?.size || 'N/A' }}</span>
                        </div>
                        <div class="field-row">
                          <span class="field-name">Year Established:</span>
                          <span class="field-value">{{ version.change_info?.old_values?.established || 'N/A' }}</span>
                        </div>
                        <div class="field-row">
                          <span class="field-name">Revenue Range:</span>
                          <span class="field-value">{{ version.change_info?.old_values?.revenue || 'N/A' }}</span>
                        </div>
                        <div class="field-row">
                          <span class="field-name">Market Segments:</span>
                          <span class="field-value">{{ isArray(version.change_info?.old_values?.market_segments) ? version.change_info.old_values.market_segments.join(', ') : 'N/A' }}</span>
                        </div>
                        <div class="field-row">
                          <span class="field-name">Technology Focus:</span>
                          <span class="field-value">{{ isArray(version.change_info?.old_values?.technology_focus) ? version.change_info.old_values.technology_focus.join(', ') : 'N/A' }}</span>
                        </div>
                        <div class="field-row">
                          <span class="field-name">Key Markets:</span>
                          <span class="field-value">{{ isArray(version.change_info?.old_values?.key_markets) ? version.change_info.old_values.key_markets.join(', ') : 'N/A' }}</span>
                        </div>
                        <div class="field-row">
                          <span class="field-name">Customer Segments:</span>
                          <span class="field-value">{{ isArray(version.change_info?.old_values?.customer_segments) ? version.change_info.old_values.customer_segments.join(', ') : 'N/A' }}</span>
                        </div>
                        <div class="field-row">
                          <span class="field-name">Competitive Position:</span>
                          <span class="field-value">{{ version.change_info?.old_values?.competitive_position || 'N/A' }}</span>
                        </div>
                        <div class="field-row">
                          <span class="field-name">Partnerships:</span>
                          <span class="field-value">{{ isArray(version.change_info?.old_values?.partnerships) ? version.change_info.old_values.partnerships.join(', ') : 'N/A' }}</span>
                        </div>
                        <div class="field-row">
                          <span class="field-name">Certifications:</span>
                          <span class="field-value">{{ isArray(version.change_info?.old_values?.certifications) ? version.change_info.old_values.certifications.length + ' certification(s)' : 'N/A' }}</span>
                        </div>
                        <div class="field-row">
                          <span class="field-name">Sales Channels:</span>
                          <span class="field-value">{{ isArray(version.change_info?.old_values?.sales_channels) ? version.change_info.old_values.sales_channels.join(', ') : 'N/A' }}</span>
                        </div>
                      </div>
                    </div>
                    <div class="comparison-column">
                      <div class="column-header">After</div>
                      <div class="profile-table">
                        <div class="field-row">
                          <span class="field-name">Company Name:</span>
                          <span class="field-value">{{ version.change_info?.new_values?.company_name || 'N/A' }}</span>
                        </div>
                        <div class="field-row">
                          <span class="field-name">Location:</span>
                          <span class="field-value">{{ version.change_info?.new_values?.location || 'N/A' }}</span>
                        </div>
                        <div class="field-row">
                          <span class="field-name">Contact Information:</span>
                          <span class="field-value">{{ version.change_info?.new_values?.contact || 'N/A' }}</span>
                        </div>
                        <div class="field-row">
                          <span class="field-name">Company Size:</span>
                          <span class="field-value">{{ version.change_info?.new_values?.size || 'N/A' }}</span>
                        </div>
                        <div class="field-row">
                          <span class="field-name">Year Established:</span>
                          <span class="field-value">{{ version.change_info?.new_values?.established || 'N/A' }}</span>
                        </div>
                        <div class="field-row">
                          <span class="field-name">Revenue Range:</span>
                          <span class="field-value">{{ version.change_info?.new_values?.revenue || 'N/A' }}</span>
                        </div>
                        <div class="field-row">
                          <span class="field-name">Market Segments:</span>
                          <span class="field-value">{{ isArray(version.change_info?.new_values?.market_segments) ? version.change_info.new_values.market_segments.join(', ') : 'N/A' }}</span>
                        </div>
                        <div class="field-row">
                          <span class="field-name">Technology Focus:</span>
                          <span class="field-value">{{ isArray(version.change_info?.new_values?.technology_focus) ? version.change_info.new_values.technology_focus.join(', ') : 'N/A' }}</span>
                        </div>
                        <div class="field-row">
                          <span class="field-name">Key Markets:</span>
                          <span class="field-value">{{ isArray(version.change_info?.new_values?.key_markets) ? version.change_info.new_values.key_markets.join(', ') : 'N/A' }}</span>
                        </div>
                        <div class="field-row">
                          <span class="field-name">Customer Segments:</span>
                          <span class="field-value">{{ isArray(version.change_info?.new_values?.customer_segments) ? version.change_info.new_values.customer_segments.join(', ') : 'N/A' }}</span>
                        </div>
                        <div class="field-row">
                          <span class="field-name">Competitive Position:</span>
                          <span class="field-value">{{ version.change_info?.new_values?.competitive_position || 'N/A' }}</span>
                        </div>
                        <div class="field-row">
                          <span class="field-name">Partnerships:</span>
                          <span class="field-value">{{ isArray(version.change_info?.new_values?.partnerships) ? version.change_info.new_values.partnerships.join(', ') : 'N/A' }}</span>
                        </div>
                        <div class="field-row">
                          <span class="field-name">Certifications:</span>
                          <span class="field-value">{{ isArray(version.change_info?.new_values?.certifications) ? version.change_info.new_values.certifications.length + ' certification(s)' : 'N/A' }}</span>
                        </div>
                        <div class="field-row">
                          <span class="field-name">Sales Channels:</span>
                          <span class="field-value">{{ isArray(version.change_info?.new_values?.sales_channels) ? version.change_info.new_values.sales_channels.join(', ') : 'N/A' }}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Show message if no comparison data available -->
                  <div *ngIf="!version.change_info.old_values || !version.change_info.new_values" class="no-comparison-data">
                    <p>‚ö†Ô∏è Comparison data not available for this version.</p>
                    <p>This might be the initial version or the change tracking data is incomplete.</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- No History Message -->
            <div *ngIf="!regulatorProfileData.history || regulatorProfileData.history.length === 0" class="no-history">
              <p>No profile history available.</p>
              <p>This might be the first version of the profile.</p>
            </div>
          </div>
        </div>


      </div>
    </div>

  </div>
</main>

<style>
  /* Profile Header with Actions */
  .profile-header-with-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #e0e0e0;
  }

  .profile-header-with-actions h2 {
    margin: 0;
    color: #2c3e50;
  }

  .profile-actions {
    display: flex;
    gap: 1rem;
  }

  .profile-actions .btn {
    padding: 0.75rem 1.5rem;
    font-size: 0.95rem;
    font-weight: 600;
    border-radius: 0.5rem;
    transition: all 0.3s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .profile-actions .btn-primary {
    background: #007bff;
    border: 1px solid #007bff;
    color: white;
  }

  .profile-actions .btn-secondary {
    background: #6c757d;
    border: 1px solid #6c757d;
    color: white;
  }

  .profile-actions .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
  }

  /* Debug Information */
  .debug-info {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 5px;
    padding: 15px;
    margin: 15px 0;
    font-family: monospace;
    font-size: 0.9rem;
  }

  .debug-info h4 {
    margin-top: 0;
    color: #495057;
    border-bottom: 1px solid #dee2e6;
    padding-bottom: 8px;
  }

  .debug-info p {
    margin: 5px 0;
    color: #6c757d;
  }

  /* Simple Comparison */
  .simple-comparison {
    margin-top: 20px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 5px;
  }

  .simple-comparison h4 {
    margin-top: 0;
    color: #495057;
    border-bottom: 1px solid #dee2e6;
    padding-bottom: 8px;
  }

  .comparison-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-top: 15px;
  }

  .comparison-column {
    border: 1px solid #dee2e6;
    border-radius: 5px;
    padding: 15px;
    background: white;
  }

  .column-header {
    font-weight: bold;
    text-align: center;
    padding: 8px;
    background: #007bff;
    color: white;
    border-radius: 3px;
    margin-bottom: 15px;
  }

  .field-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    padding: 5px;
    border-bottom: 1px solid #f0f0f0;
  }

  .field-name {
    font-weight: bold;
    color: #495057;
  }

  .field-value {
    color: #6c757d;
    max-width: 200px;
    word-break: break-word;
  }

  /* No History Message */
  .no-history {
    text-align: center;
    padding: 40px 20px;
    background: #f8f9fa;
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    margin: 20px 0;
  }

  .no-history p {
    margin: 10px 0;
    color: #6c757d;
    font-size: 1.1rem;
  }

  /* Responsive design for profile header */
  @media (max-width: 768px) {
    .profile-header-with-actions {
      flex-direction: column;
      align-items: flex-start;
      gap: 1rem;
    }

    .profile-actions {
      width: 100%;
    }

    .profile-actions .btn {
      width: 100%;
      text-align: center;
    }

    .comparison-grid {
      grid-template-columns: 1fr;
    }
  }
</style>